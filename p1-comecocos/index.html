<!DOCTYPE html>
<html lang="es-es">
<!--http://www.w3schools.com/graphics/game_intro.asp-->
<head>
    <title>Pacman 1.0 by mghfdez</title>
    <link rel="shortcut icon" href="images/blue-ghost.png"/>
    <meta charset="UTF-8">
    <meta name="description" content="Comecocos 1.0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Miguel Angel Fernandez Sanchez">
    <style>
    .header-footer {
    padding: 1em;
    color: white;
    background-color: black;
    clear: left;
    text-align: center;
    }
    canvas {
        border:1px solid blue;
        background-color: black;
    }
    .canvas-space {
      padding: 3em;
      align: center;
    }
    body {
        background-image:url(images/Pacman-Ghosts-Fever-4K-UHD-Wallpaper.jpg);
        font-family: helvetica;
        margin-left:20px;
    }

    .button {
        align: center;
        display: inline-block;
        padding: 15px 25px;
        font-size: 24px;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: #fff;
        background-color: #008CBA;
        border: none;
        border-radius: 40px;
        box-shadow: 0 9px #999;
        width: 600px;
    }

    .button:hover {background-color: #3e8e41}

    .button:active {
      background-color: #3e8e41;
      box-shadow: 0 5px #666;
      transform: translateY(4px);
    }
    </style>
</head>
<body onload="prestartGame();">
  <div class="canvas-space">
    <script>

    var homerdoh_img = new Image();
    homerdoh_img.src = 'images/homersimpsondoh.png';

    var blue_ghost_img = new Image();
    blue_ghost_img.src = 'images/blue-ghost.png';
    var pacman_img = new Image();
    pacman_img.src = 'images/pacman.png';
    var orange_ghost_img = new Image();
    orange_ghost_img.src = 'images/orange-ghost.png';
    var red_ghost_img = new Image();
    red_ghost_img.src = 'images/red-ghost.png';

    var white_dot_img = new Image();
    white_dot_img.src = 'images/whitedot.png';

    var myPacman;
    var myBlueGhost;
    var myOrangeGhost;
    var myRedGhost;
    var myObstacles;
    var myDots;

    var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 800;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        this.context.font = "60px Verdana";
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            myGameArea.key = e.keyCode;
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.key = false;
        })
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    stop : function() {
        clearInterval(this.interval);
    }
    }

    function everyinterval(n) {
        if ((myGameArea.frameNo / n) % 1 == 0) {return true;}
        return false;
    }

    function sound(src) {
    this.sound = document.createElement("audio");
    this.sound.src = src;
    this.sound.setAttribute("preload", "auto");
    this.sound.setAttribute("controls", "none");
    this.sound.style.display = "none";
    document.body.appendChild(this.sound);
    this.play = function(){
        this.sound.play();

    }
    this.stop = function(){
        this.sound.pause();
        document.getElementById("sound-start").style.display='block';
    }
    }

    function restartGame(){
        myGameArea.clear();
        startGame();
    }

    function prestartGame(){
      myBeginningMusic = new sound("sounds/pacman_beginning.wav");
      myBeginningMusic.play();
      document.getElementById("sound-start").style.display='none';
      document.getElementById("sound-stop").style.display='none';
      document.getElementById("restart").style.display='none';
    }

    function startGame() {

        document.getElementById("restart").style.display='none';
        document.getElementById("start").style.display='none';

        myGameArea.start();

        myBackgroundMusic = new sound("sounds/dp-atw.mp3");

        mySirenSound = new sound("sounds/pacman_siren_cut.mp3");
        myWakaSound = new sound("sounds/pacman_chomp.wav");
        myDeathSound = new sound("sounds/pacman_death.wav");

        myPacman = new component(35, 35, 430, 430, 0, 0, pacman_img,'char');
        myBlueGhost = new component(35, 35, 45, 170, 2, 0, blue_ghost_img,'char');
        myOrangeGhost = new component(35, 35, 170, 170, 0, 2, orange_ghost_img, 'char');
        myRedGhost = new component(35, 35, 500, 430, 2, 0, red_ghost_img, 'char');

        //Antes: velocidades 2,0 ; 0,2 ; 2,0
        //Dibujo escenario
        c1  = new component(140, 140, 0, 0, 0, 0, 'blue', 'rect');
        c2  = new component(140, 140, myGameArea.canvas.width-140, 0, 0, 0, 'blue', 'rect');
        c3  = new component(140, 140, 0, myGameArea.canvas.height-140, 0, 0, 'blue', 'rect');
        c4  = new component(140, 140, myGameArea.canvas.width-140, myGameArea.canvas.height-140, 0, 0, 'blue', 'rect');

        c5  = new component(400, 140, 200, 0, 0, 0, 'blue', 'rect');
        c6  = new component(400, 140, 200, 460, 0, 0, 'blue', 'rect');
        c7  = new component(400, 200, 200, 200, 0, 0, 'blue', 'rect');

        c8  = new component(140, 200, 0, 200, 0, 0, 'blue', 'rect');
        c9  = new component(140, 200, 660, 200, 0, 0, 'blue', 'rect');


        myObstacles = [c1,c2,c3,c4,c5,c6,c7,c8,c9];

        myDot = new component(20, 20, 315, 430, 0, 0, white_dot_img, 'elem');
        myDot2 = new component(20, 20, 280, 430, 0, 0, white_dot_img, 'elem');
        myDots = [myDot, myDot2];

        myBackgroundMusic.play();
        document.getElementById("sound-start").style.display='none';
        document.getElementById("sound-stop").style.display='block';
    }

    function component(width, height, x, y, speedX, speedY, image, type) {
        this.width = width;
        this.height = height;
        this.speedX = speedX;
        this.speedY = speedY;
        this.x = x;
        this.y = y;
        this.angle = 0;
        this.image = image;
        if (type == "rect"){
            this.update = function() {
                ctx = myGameArea.context;
                ctx.fillStyle = image;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
        }else{
            this.update = function(){
                ctx = myGameArea.context;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.drawImage(this.image, this.width/-2, this.height/-2, this.width, this.height);
                ctx.restore();
            }
        }
        this.newPos = function() {
          this.x += this.speedX;
          this.y += this.speedY;
        }
        this.crashWith = function(otherobj) {
        var myleft = this.x;
        var myright = this.x + (this.width);
        var mytop = this.y;
        var mybottom = this.y + (this.height);
        var otherleft = otherobj.x + (this.width/2);
        var otherright = otherobj.x + (otherobj.width) + (this.width/2);
        var othertop = otherobj.y + (this.height/2);
        var otherbottom = otherobj.y + (otherobj.height) + (this.height/2);
        var crash = true;
        if ((mybottom < othertop) ||
               (mytop > otherbottom) ||
               (myright < otherleft) ||
               (myleft > otherright)) {
           crash = false;
        }
        return crash;
        }
      }

    function controlCharacter(character){
        // Imprimir posicion de teclado
        this.character = character;
        if (myGameArea.key && myGameArea.key == 37) {this.character.speedX = -3; this.character.speedY = 0; this.character.angle = Math.PI;}
        if (myGameArea.key && myGameArea.key == 39) {this.character.speedX = 3; this.character.speedY = 0; this.character.angle = 0; }
        if (myGameArea.key && myGameArea.key == 38) {this.character.speedY = -3; this.character.speedX = 0; this.character.angle = -Math.PI/2;}
        if (myGameArea.key && myGameArea.key == 40) {this.character.speedY = 3; this.character.speedX = 0; this.character.angle = Math.PI/2;}
        if (this.character.speedX != 0 || this.character.speedY != 0) {
          mySirenSound.play();
        }
        crashBorder(character);
    }

    function crashBorder(character){
      this.limitX =  myGameArea.canvas.width ;
      this.limitY = myGameArea.canvas.height ;
      if (this.character.x > (this.limitX - (this.character.width/2))){
        this.character.speedX = -2; this.character.speedY = 0;
      } else if (this.character.y > (this.limitY - (this.character.height/2))) {
        this.character.speedY = -2; this.character.speedX = 0;
      } else if (this.character.x < (this.character.width/2)) {
        this.character.speedX = 2; this.character.speedY = 0;
        } else if (this.character.y < (this.character.height/2)) {
        this.character.speedY = 2; this.character.speedX = 0;
      }
    }

    function updateGameArea() {
        if (myPacman.crashWith(myBlueGhost) || myPacman.crashWith(myOrangeGhost) || myPacman.crashWith(myRedGhost)) {

            myBackgroundMusic.stop();
            document.getElementById("sound-stop").style.display='none';
            myDeathSound.play();
            myGameArea.stop();
            myGameArea.clear();

            cur_ctx = myGameArea.context;
            cur_ctx.fillStyle = "red";
            cur_ctx.textAlign = "center";
            cur_ctx.fillText("Game Over", myGameArea.canvas.width/3, myGameArea.canvas.height/3);
            cur_ctx.drawImage(homerdoh_img, myGameArea.canvas.width-255, myGameArea.canvas.height-300, 255, 300);
            document.getElementById("restart").style.display='block';

        } else {

            myGameArea.clear();

            lastspeedX = myPacman.speedX;
            lastspeedY = myPacman.speedY;
            stopCharacter(myPacman);
            controlCharacter(myPacman);

            for (i = 0; i < myObstacles.length; i += 1) {
              if (myPacman.crashWith(myObstacles[i])) {
                  console.log("Changing: ", lastspeedX, lastspeedY)
                  myPacman.speedX = -lastspeedX;
                  myPacman.speedY = -lastspeedY;
                  console.log("crashing with object:");
                  console.log(myObstacles[i].x, myObstacles[i].y);
              }
            }

            myPacman.newPos();

            for (i = 0; i < myDots.length; i += 1) {
              if (myPacman.crashWith(myDots[i])) {
                myDots[i].width = 0;
                myDots[i].height = 0;
              }
            }

            moveCharacter(myBlueGhost, 'horizontal');
            myBlueGhost.newPos();

            moveCharacter(myOrangeGhost, 'vertical');
            myOrangeGhost.newPos();

            moveCharacter(myRedGhost, 'horizontal');
            myRedGhost.newPos();


            for (i = 0; i < myObstacles.length; i += 1) {
              myObstacles[i].update();
            }

            for (i = 0; i < myDots.length; i += 1) {
              console.log(myDots[i]);
              myDots[i].update();
            }

            myPacman.update();
            myBlueGhost.update();
            myOrangeGhost.update();
            myRedGhost.update();
        }
    }

    function stopCharacter(character){
      this.character = character;
      this.character.speedX = 0;
      this.character.speedY = 0;
    }

    function moveCharacter(character, mode){
      this.character = character;
      crashBorder(character);
      /*FIXME: Poner velocidad del personaje como parÃ¡metro*/
      /*TODO*/
    }


    </script>
  </div>
  <div>
      <button class="button" id="start" onclick="startGame();">Start Game</button>
      <button class="button" id="restart" onclick="restartGame();">Restart Game</button>
      <button class="button" id="sound-start" onclick="myBackgroundMusic.stop(); myBackgroundMusic.play();">Start Music</button>
      <button class="button" id="sound-stop" onclick="myBackgroundMusic.stop();">Stop Music</button>
  </div>
</body>
</html>
